/*!

* sense-angular-directives - AngularJS directives ready to be used in Qlik Sense visualization extensions.
* --
* @version v0.4.0
* @link https://github.com/stefanwalther/sense-angular-directives
* @author Stefan Walther
* @license MIT
*/

/*
 1:1 port of angular-tooltips to be used in Qlik Sense extensions.

 Copyright (c) 2014 Filippo Oretti, Dario Andrei
 https://github.com/720kb/angular-tooltips
 The MIT License (MIT)
 */
define(["qvangular","angular"],function(qvangular,angular){"use strict";qvangular.directive("euiTooltip",["$window","$compile","$interpolate","$interval",function($window,$compile,$interpolate,$interval){var TOOLTIP_SMALL_MARGIN=8,TOOLTIP_MEDIUM_MARGIN=9,TOOLTIP_LARGE_MARGIN=10,POSITION_CHECK_INTERVAL=20,CSS_PREFIX="eui-tooltip-",INTERPOLATE_START_SYM=$interpolate.startSymbol(),INTERPOLATE_END_SYM=$interpolate.endSymbol();return{restrict:"A",scope:{},link:function($scope,element,attr){function onMouseEnterAndMouseOver(){lazyMode&&initialized||(initialized=!0,$scope.initTooltip(side)),tryPosition&&$scope.tooltipTryPosition(),$scope.showTooltip()}function onMouseLeaveAndMouseOut(){$scope.hideTooltip()}function onResize(){$scope.hideTooltip(),$scope.initTooltip(originSide)}var theTooltip,theTooltipHeight,theTooltipWidth,theTooltipMargin,height,width,offsetTop,offsetLeft,positionInterval,oldBoundingRect,initialized=!1,thisElement=angular.element(element[0]),body=angular.element($window.document.getElementsByTagName("body")[0]),title=attr.tooltipTitle||attr.title||"",tooltipScroll=attr.tooltipScroll||!1,content=attr.tooltipContent||"",html=attr.tooltipHtml||"",showTriggers=attr.tooltipShowTrigger||"mouseover",hideTriggers=attr.tooltipHideTrigger||"mouseleave",hideTarget="undefined"!=typeof attr.tooltipHideTarget&&null!==attr.tooltipHideTarget?attr.tooltipHideTarget:"element",originSide=attr.tooltipSide||"top",side=originSide,size=attr.tooltipSize||"medium",tryPosition="undefined"==typeof attr.tooltipTry||null===attr.tooltipTry||$scope.$eval(attr.tooltipTry),className=attr.tooltipClass||"",speed=(attr.tooltipSpeed||"medium").toLowerCase(),delay=attr.tooltipDelay||0,lazyMode="undefined"==typeof attr.tooltipLazy||null===attr.tooltipLazy||$scope.$eval(attr.tooltipLazy),hasCloseButton="undefined"!=typeof attr.tooltipCloseButton&&null!==attr.tooltipCloseButton,closeButtonContent=attr.tooltipCloseButton||"",htmlTemplate='<div class="eui-tooltip '+CSS_PREFIX+size+'">';"element"!==hideTarget&&"tooltip"!==hideTarget&&(hideTarget="element"),hasCloseButton&&(htmlTemplate=htmlTemplate+'<span class="'+CSS_PREFIX+'close-button" ng-click="hideTooltip()"> '+closeButtonContent+" </span>"),attr.tooltipView&&(htmlTemplate=attr.tooltipViewCtrl?htmlTemplate+'<div ng-controller="'+attr.tooltipViewCtrl+'" ng-include="\''+attr.tooltipView+"'\"></div>":htmlTemplate+"<div ng-include=\"'"+attr.tooltipView+"'\"></div>"),htmlTemplate=htmlTemplate+'<div class="'+CSS_PREFIX+'title"> '+INTERPOLATE_START_SYM+"title"+INTERPOLATE_END_SYM+"</div>"+INTERPOLATE_START_SYM+"content"+INTERPOLATE_END_SYM+html+' <span class="'+CSS_PREFIX+'caret"></span></div>',$scope.title=title,$scope.content=content,$scope.html=html,$scope.parseSpeed=function(){switch(speed){case"fast":speed=100;break;case"medium":speed=450;break;case"slow":speed=800;break;default:speed=Number(speed)}},theTooltip=$compile(htmlTemplate)($scope),theTooltip.addClass(className),body.append(theTooltip),$scope.isTooltipEmpty=function(){if(!$scope.title&&!$scope.content&&!$scope.html)return!0},$scope.initTooltip=function(tooltipSide){$scope.isTooltipEmpty()?theTooltip.css("visibility","hidden"):(theTooltip.css("visibility","visible"),height=thisElement[0].offsetHeight,width=thisElement[0].offsetWidth,theTooltipHeight=theTooltip[0].offsetHeight,theTooltipWidth=theTooltip[0].offsetWidth,$scope.parseSpeed(),$scope.tooltipPositioning(tooltipSide))},$scope.getOffsets=function(){offsetTop=$scope.getOffsetTop(thisElement[0]),offsetLeft=$scope.getOffsetLeft(thisElement[0])},$scope.getOffsetTop=function(elem){var offtop=elem.getBoundingClientRect().top+$window.scrollY;return isNaN(offtop)&&(offtop=elem.getBoundingClientRect().top+$window.pageYOffset),offtop},$scope.getOffsetLeft=function(elem){var offleft=elem.getBoundingClientRect().left+$window.scrollX;return isNaN(offleft)&&(offleft=elem.getBoundingClientRect().left+$window.pageXOffset),offleft},$scope.bindShowTriggers=function(){thisElement.bind(showTriggers,onMouseEnterAndMouseOver)},$scope.bindHideTriggers=function(){"tooltip"===hideTarget?theTooltip.bind(hideTriggers,onMouseLeaveAndMouseOut):thisElement.bind(hideTriggers,onMouseLeaveAndMouseOut)},$scope.clearTriggers=function(){thisElement.unbind(showTriggers,onMouseEnterAndMouseOver),thisElement.unbind(hideTriggers,onMouseLeaveAndMouseOut)},$scope.bindShowTriggers(),$scope.showTooltip=function(){tooltipScroll&&(oldBoundingRect=thisElement[0].getBoundingClientRect(),positionInterval=$interval(function(){var newBoundingRect=thisElement[0].getBoundingClientRect();angular.equals(oldBoundingRect,newBoundingRect)||$scope.tooltipPositioning(side),oldBoundingRect=newBoundingRect},POSITION_CHECK_INTERVAL)),theTooltip.addClass(CSS_PREFIX+"open"),theTooltip.css("transition","opacity "+speed+"ms linear"),delay&&theTooltip.css("transition-delay",delay+"ms"),$scope.clearTriggers(),$scope.bindHideTriggers()},$scope.hideTooltip=function(){theTooltip.css("transition","opacity "+speed+"ms linear, visibility 0s linear "+speed+"ms"),theTooltip.removeClass(CSS_PREFIX+"open"),$scope.clearTriggers(),$scope.bindShowTriggers(),angular.isDefined($scope.positionInterval)&&($interval.cancel(positionInterval),positionInterval=void 0)},$scope.removePosition=function(){theTooltip.removeClass(CSS_PREFIX+"left").removeClass(CSS_PREFIX+"right").removeClass(CSS_PREFIX+"top").removeClass(CSS_PREFIX+"bottom ")},$scope.tooltipPositioning=function(tooltipSide){$scope.removePosition(),$scope.getOffsets();var topValue,leftValue;"small"===size?theTooltipMargin=TOOLTIP_SMALL_MARGIN:"medium"===size?theTooltipMargin=TOOLTIP_MEDIUM_MARGIN:"large"===size&&(theTooltipMargin=TOOLTIP_LARGE_MARGIN),"left"===tooltipSide&&(topValue=offsetTop+height/2-theTooltipHeight/2,leftValue=offsetLeft-(theTooltipWidth+theTooltipMargin),theTooltip.css("top",topValue+"px"),theTooltip.css("left",leftValue+"px"),theTooltip.addClass(CSS_PREFIX+"left")),"right"===tooltipSide&&(topValue=offsetTop+height/2-theTooltipHeight/2,leftValue=offsetLeft+width+theTooltipMargin,theTooltip.css("top",topValue+"px"),theTooltip.css("left",leftValue+"px"),theTooltip.addClass(CSS_PREFIX+"right")),"top"===tooltipSide&&(topValue=offsetTop-theTooltipMargin-theTooltipHeight,leftValue=offsetLeft+width/2-theTooltipWidth/2,theTooltip.css("top",topValue+"px"),theTooltip.css("left",leftValue+"px"),theTooltip.addClass(CSS_PREFIX+"top")),"bottom"===tooltipSide&&(topValue=offsetTop+height+theTooltipMargin,leftValue=offsetLeft+width/2-theTooltipWidth/2,theTooltip.css("top",topValue+"px"),theTooltip.css("left",leftValue+"px"),theTooltip.addClass(CSS_PREFIX+"bottom"))},$scope.tooltipTryPosition=function(){var theTooltipH=theTooltip[0].offsetHeight,theTooltipW=theTooltip[0].offsetWidth,topOffset=theTooltip[0].offsetTop,leftOffset=theTooltip[0].offsetLeft,winWidth=$window.innerWidth,winHeight=$window.innerHeight,rightOffset=winWidth-(theTooltipW+leftOffset),bottomOffset=winHeight-(theTooltipH+topOffset),elmWidth=(thisElement[0].offsetHeight,thisElement[0].offsetWidth),elmOffsetLeft=thisElement[0].offsetLeft,elmOffsetTop=thisElement[0].offsetTop,elmOffsetRight=winWidth-(elmOffsetLeft+elmWidth),offsets={left:leftOffset,top:topOffset,bottom:bottomOffset,right:rightOffset},posix={left:elmOffsetLeft,right:elmOffsetRight,top:elmOffsetTop,bottom:elmOffsetBottomvar},bestPosition=Object.keys(posix).reduce(function(best,key){return posix[best]>posix[key]?best:key}),worstOffset=Object.keys(offsets).reduce(function(worst,key){return offsets[worst]<offsets[key]?worst:key});originSide!==bestPosition&&offsets[worstOffset]<20&&(side=bestPosition,$scope.tooltipPositioning(side),$scope.initTooltip(bestPosition))},angular.element($window).bind("resize",onResize),$scope.$on("$destroy",function(){angular.element($window).unbind("resize",onResize),$scope.clearTriggers(),theTooltip.remove()}),attr.tooltipTitle&&attr.$observe("tooltipTitle",function(val){$scope.title=val,$scope.initTooltip(side)}),attr.title&&attr.$observe("title",function(val){$scope.title=val,$scope.initTooltip(side)}),attr.tooltipContent&&attr.$observe("tooltipContent",function(val){$scope.content=val,$scope.initTooltip(side)}),attr.tooltipHtml&&attr.$observe("tooltipHtml",function(val){$scope.html=val,$scope.initTooltip(side)})}}}])});
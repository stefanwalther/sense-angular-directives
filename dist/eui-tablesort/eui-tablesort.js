/*!

* sense-angular-directives - AngularJS directives ready to be used in Qlik Sense visualization extensions.
* --
* @version v0.4.0
* @link https://github.com/stefanwalther/sense-angular-directives
* @author Stefan Walther
* @license MIT
*/

/* global define */
/*

 Modified version of angular-tablesort to play nicely with Qlik Sense.

 angular-tablesort v1.1.0
 (c) 2013-2015 Mattias Holmlund, http://mattiash.github.io/angular-tablesort
 License: MIT
 */
define(["qvangular","angular"],function(qvangular,angular){"use strict";qvangular.directive("euiTsWrapper",["$log","$parse",function($log,$parse){return{scope:!0,controller:["$scope",function($scope){$scope.sortExpression=[],$scope.headings=[];var parse_sortexpr=function(expr){return[$parse(expr),null,!1]};this.setSortField=function(sortexpr,element){var i,expr=parse_sortexpr(sortexpr);if(1===$scope.sortExpression.length&&$scope.sortExpression[0][0]===expr[0])$scope.sortExpression[0][2]?(element.removeClass("tablesort-desc"),element.addClass("tablesort-asc"),$scope.sortExpression[0][2]=!1):(element.removeClass("tablesort-asc"),element.addClass("tablesort-desc"),$scope.sortExpression[0][2]=!0);else{for(i=0;i<$scope.headings.length;i+=1)$scope.headings[i].removeClass("tablesort-desc").removeClass("tablesort-asc");element.addClass("tablesort-asc"),$scope.sortExpression=[expr]}},this.addSortField=function(sortexpr,element){var i,toggle_order=!1,expr=parse_sortexpr(sortexpr);for(i=0;i<$scope.sortExpression.length;i+=1)$scope.sortExpression[i][0]===expr[0]&&($scope.sortExpression[i][2]?(element.removeClass("tablesort-desc"),element.addClass("tablesort-asc"),$scope.sortExpression[i][2]=!1):(element.removeClass("tablesort-asc"),element.addClass("tablesort-desc"),$scope.sortExpression[i][2]=!0),toggle_order=!0);toggle_order||(element.addClass("tablesort-asc"),$scope.sortExpression.push(expr))},this.setTrackBy=function(trackBy){$scope.trackBy=trackBy},this.registerHeading=function(headingelement){$scope.headings.push(headingelement)},$scope.sortFun=function(a,b){var i,aval,bval,descending,filterFun;for(i=0;i<$scope.sortExpression.length;i+=1){if(aval=$scope.sortExpression[i][0](a),bval=$scope.sortExpression[i][0](b),filterFun=b[$scope.sortExpression[i][1]],filterFun&&(aval=filterFun(aval),bval=filterFun(bval)),void 0!==aval&&null!==aval||(aval=""),void 0!==bval&&null!==bval||(bval=""),descending=$scope.sortExpression[i][2],aval>bval)return descending?-1:1;if(aval<bval)return descending?1:-1}if($scope.trackBy){if(aval=a[$scope.trackBy],bval=b[$scope.trackBy],void 0!==aval&&null!==aval||(aval=""),void 0!==bval&&null!==bval||(bval=""),aval>bval)return descending?-1:1;if(aval<bval)return descending?1:-1}return 0}}]}}]),qvangular.directive("tsCriteria",function(){return{require:"^euiTsWrapper",link:function(scope,element,attrs,tsWrapperCtrl){var clickingCallback=function(event){scope.$apply(function(){event.shiftKey?tsWrapperCtrl.addSortField(attrs.tsCriteria,element):tsWrapperCtrl.setSortField(attrs.tsCriteria,element)})};element.bind("click",clickingCallback),element.addClass("tablesort-sortable"),"tsDefault"in attrs&&"0"!==attrs.tsDefault&&(tsWrapperCtrl.addSortField(attrs.tsCriteria,element),"descending"===attrs.tsDefault&&tsWrapperCtrl.addSortField(attrs.tsCriteria,element)),tsWrapperCtrl.registerHeading(element)}}}),qvangular.directive("tsRepeat",["$compile",function($compile){return{terminal:!0,multiElement:!0,require:"^euiTsWrapper",priority:1e6,link:function(scope,element,attrs,tsWrapperCtrl){for(var repeatAttrs=["ng-repeat","data-ng-repeat","ng-repeat-start","data-ng-repeat-start"],ngRepeatDirective=repeatAttrs[0],tsRepeatDirective="ts-repeat",i=0;i<repeatAttrs.length;i++)if(angular.isDefined(element.attr(repeatAttrs[i]))){ngRepeatDirective=repeatAttrs[i],tsRepeatDirective=ngRepeatDirective.replace(/^ng/,"ts");break}var repeatExpr=element.attr(ngRepeatDirective),trackBy=null,trackByMatch=repeatExpr.match(/\s+track\s+by\s+\S+?\.(\S+)/);trackByMatch&&(trackBy=trackByMatch[1],tsWrapperCtrl.setTrackBy(trackBy)),repeatExpr=repeatExpr.search(/tablesort/)!==-1?repeatExpr.replace(/tablesort/,"tablesortOrderBy:sortFun"):repeatExpr.replace(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(\s+track\s+by\s+[\s\S]+?)?\s*$/,"$1 in $2 | tablesortOrderBy:sortFun$3");var noDataRow=angular.element(element[0]).clone();noDataRow.removeAttr(ngRepeatDirective),noDataRow.removeAttr(tsRepeatDirective),noDataRow.addClass("showIfLast"),noDataRow.children().remove(),noDataRow.append('<td colspan="'+element[0].childElementCount+'"></td>'),noDataRow=$compile(noDataRow)(scope),element.parent().prepend(noDataRow),angular.element(element[0]).attr(ngRepeatDirective,repeatExpr),$compile(element,null,1e6)(scope)}}}]),qvangular.filter("tablesortOrderBy",function(){return function(array,sortfun){if(array){for(var arrayCopy=[],i=0;i<array.length;i++)arrayCopy.push(array[i]);return arrayCopy.sort(sortfun)}}}),qvangular.filter("parseInt",function(){return function(input){return parseInt(input,10)||null}}),qvangular.filter("parseFloat",function(){return function(input){return parseFloat(input)||null}})});